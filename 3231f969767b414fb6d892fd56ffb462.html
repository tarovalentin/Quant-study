<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>cada524c625d40ba93a680a9fef76b68</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="intro-to-monte-carlo-methods-for-option-pricing"
class="cell markdown">
<h2>Intro to Monte Carlo methods for option pricing</h2>
</section>
<div class="cell code" data-execution_count="409">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear all variables (habit from MATLAB)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>reset <span class="op">-</span>f</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<section id="essential-pythonnumpy-functions-and-techniques"
class="cell markdown">
<h2>Essential python/numpy functions and techniques</h2>
</section>
<div class="cell markdown">
<p><strong><em>Essential Numpy Moves</em></strong></p>
<p><strong>E1:</strong></p>
<p>Create a 1¬†000¬†000‚Äësample vector of i.i.d. ùí©(0,¬†1) numbers. 2.
Re‚Äëcreate it as¬†float32 without an explicit loop.</p>
</div>
<div class="cell code" data-execution_count="5">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x64 <span class="op">=</span> np.random.standard_normal((<span class="dv">1000000</span>,<span class="dv">1</span>)) <span class="co"># produce 1 million &quot;independent and identically distributed&quot; (iid) random numbers.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x64[<span class="dv">1</span>:<span class="dv">5</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>x32 <span class="op">=</span> x64.astype(np.float32) <span class="co"># convert to 32 bit float</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>[[-0.29274736]
 [ 0.74768368]
 [ 0.83232078]
 [ 0.06265928]]
</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong>E2:</strong></p>
<p>Turn a 100¬†√ó¬†100 matrix into a 10¬†√ó¬†10¬†√ó¬†100 ‚Äúbatch cube‚Äù where each
frontal slice is 10¬†√ó¬†10</p>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.random.standard_normal((<span class="dv">100</span>,<span class="dv">100</span>)) <span class="co"># produce 100 x 100 iid random numbers.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> X.reshape(<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">100</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p><strong>E3</strong></p>
<p>Compute all pairwise dot‚Äëproducts of 100 random 3‚ÄëD vectors with and
without a for‚Äëloop.</p>
</div>
<div class="cell code" data-execution_count="9">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>V <span class="op">=</span> np.zeros((N,N), <span class="bu">int</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># first with a for loop</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>v1 <span class="op">=</span> np.random.randint(<span class="dv">1</span>,<span class="dv">10</span>,(N,<span class="dv">3</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>start_time_1 <span class="op">=</span> time.time()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        V[i,j] <span class="op">=</span> np.dot(v1[i],v1[j].T)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>end_time_1 <span class="op">=</span> time.time()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># now with einsum</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>start_time_2 <span class="op">=</span> time.time()</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>d2 <span class="op">=</span> np.einsum(<span class="st">&#39;ik,jk-&gt;ij&#39;</span>, v1, v1)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>end_time_2 <span class="op">=</span> time.time()</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>execution_time_1 <span class="op">=</span> end_time_1 <span class="op">-</span> start_time_1</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>execution_time_2 <span class="op">=</span> end_time_2 <span class="op">-</span> start_time_2</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>ex_diff <span class="op">=</span> execution_time_1 <span class="op">-</span> execution_time_2</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Execution time difference in for loop vs einsum: </span><span class="sc">{</span>ex_diff<span class="sc">}</span><span class="ss"> seconds&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Execution time difference in for loop vs einsum: 0.039880990982055664 seconds
</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong>E3</strong></p>
<p>Compute the product of</p>
<p>1) Two matrices 2) Matrix with a vector 3) Batched matrix
multiplication 4) Using broadcastring compute the product of a batch of
matrices with a single matrix</p>
</div>
<div class="cell code" data-execution_count="11">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.array([[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>]])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> np.array([[<span class="dv">5</span>, <span class="dv">6</span>], [<span class="dv">7</span>, <span class="dv">8</span>]])</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">6</span>])</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> np.einsum(<span class="st">&#39;ij,jk-&gt;ik&#39;</span>, A, B)  <span class="co"># Matrix multiplication using einsum</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> np.matmul(A, B)  <span class="co"># Matrix multiplication using matmul</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(C<span class="op">==</span>D) <span class="co"># Check if the results are the same</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> np.einsum(<span class="st">&#39;ij,j -&gt; i&#39;</span>, A, v) </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>X2 <span class="op">=</span> np.matmul(A, v)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>X1<span class="op">-</span>X2 <span class="co"># Check if the results are the same</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> np.array([[[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>]], [[<span class="dv">5</span>, <span class="dv">6</span>], [<span class="dv">7</span>, <span class="dv">8</span>]]])</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>E <span class="op">=</span> np.array([[[<span class="dv">9</span>, <span class="dv">8</span>], [<span class="dv">7</span>, <span class="dv">6</span>]], [[<span class="dv">5</span>, <span class="dv">4</span>], [<span class="dv">3</span>, <span class="dv">2</span>]]])</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>X3 <span class="op">=</span> np.matmul(D, E)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X3)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> np.array([[[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>]], [[<span class="dv">5</span>, <span class="dv">6</span>], [<span class="dv">7</span>, <span class="dv">8</span>]]])</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> np.array([[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>]])</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> np.matmul(F, G)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>[[ True  True]
 [ True  True]]
[[[23 20]
  [55 48]]

 [[43 32]
  [59 44]]]
[[[ 7 10]
  [15 22]]

 [[23 34]
  [31 46]]]
</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong>E3</strong></p>
<p>Generate 100 paths of geometric Brownian motion, each with 1000
timesteps, return a vector of pathwise means in one line.</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.standard_normal((<span class="dv">100</span>, <span class="dv">1000</span>)) <span class="co"># produce 100 x 1000 iid random numbers </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cum_sum <span class="op">=</span> np.cumsum(y, axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># cumulative sum along the second axis</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>mean_cum_sum <span class="op">=</span> np.mean(cum_sum, axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># mean of the cumulative sum along the second axis</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------------------------------</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># In  one line</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.default_rng(<span class="dv">22</span>).standard_normal((<span class="dv">100</span>,<span class="dv">1000</span>)).cumsum(<span class="dv">1</span>).mean(<span class="dv">1</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">101</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>plt.plot(x, y, label<span class="op">=</span><span class="st">&#39;Mean of Cumulative Sum&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="44">
<pre><code>[&lt;matplotlib.lines.Line2D at 0x290483baac8&gt;]</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/16e8fe7405649982bf9ed20772e308f78c262e8a.png" /></p>
</div>
</div>
<section id="blackscholes-partial-differential-equation"
class="cell markdown">
<h2>Black‚ÄìScholes partial-differential equation</h2>
</section>
<div class="cell markdown">
<p>Analytically solve the BS equations for a European option.</p>
<hr />
<p><strong><em>The Black‚ÄìScholes Model in PDE Form</em></strong></p>
<p><strong><em>Core assumptions</em></strong></p>
<ol>
<li><strong>Underlying dynamics</strong> ‚Äì The (discounted) stock price
follows <em>geometric Brownian motion</em><br />
<span
class="math display"><em>d</em><em>S</em><sub><em>t</em></sub>‚ÄÑ=‚ÄÑ(<em>r</em>‚àí<em>q</em>)‚ÄÜ<em>S</em><sub><em>t</em></sub>‚ÄÜ<em>d</em><em>t</em>‚ÄÖ+‚ÄÖ<em>œÉ</em><em>S</em><sub><em>t</em></sub>‚ÄÜ<em>d</em><em>W</em><sub><em>t</em></sub>,</span>
with constant drift <span
class="math inline">(<em>r</em>‚àí<em>q</em>)</span> and volatility <span
class="math inline">(<em>œÉ</em>).</span></li>
<li><strong>No arbitrage &amp; frictionless markets</strong> ‚Äì You can
trade continuously, borrow/lend at the risk-free rate <span
class="math inline"><em>r</em></span>, and short without costs.<br />
</li>
<li><strong>European payoff</strong> ‚Äì The option‚Äôs payoff depends only
on <span class="math inline"><em>S</em><sub><em>T</em></sub></span> at a
fixed expiry <span class="math inline"><em>T</em></span>.</li>
</ol>
<p><strong><em>The pricing PDE</em></strong> Form a self-financing
portfolio <span
class="math inline"><em>Œ†</em>‚ÄÑ=‚ÄÑ<em>V</em>‚ÄÖ‚àí‚ÄÖ<em>Œî</em><em>S</em></span>
that is <em>locally risk-free</em> by choosing <span
class="math inline">$\Delta = \frac{\partial V}{\partial
S}$</span>.<br />
Applying It√¥‚Äôs lemma to <span
class="math inline"><em>V</em>(<em>t</em>,<em>S</em><sub><em>t</em></sub>)</span>
and equating the portfolio‚Äôs drift to the risk-free rate yields the
<strong>Black‚ÄìScholes PDE</strong></p>
<p><span class="math display">$$
\boxed{\;
\frac{\partial V}{\partial t} +
\tfrac12\sigma^{2}S^{2}\frac{\partial^{2}V}{\partial S^{2}}
      + (r-q)S\frac{\partial V}{\partial S} \;-\; rV \;=\; 0\;}
$$</span></p>
<p>with terminal condition <span
class="math inline"><em>V</em>(<em>T</em>,<em>S</em>)‚ÄÑ=‚ÄÑpayoff(<em>S</em>)</span>.</p>
<hr />
<p><strong><em>3‚ÄÉClosed-Form Solution for a European Call /
Put</em></strong> From wikipedia/book</p>
<p>Solving the PDE with payoff <span
class="math inline"><em>C</em>(<em>T</em>,<em>S</em>)‚ÄÑ=‚ÄÑmax‚ÄÜ(<em>S</em>‚àí<em>K</em>,0)</span>
(call) or <span
class="math inline"><em>P</em>(<em>T</em>,<em>S</em>)‚ÄÑ=‚ÄÑmax‚ÄÜ(<em>K</em>‚àí<em>S</em>,0)</span>
(put) gives</p>
<p><span class="math display">$$
\begin{aligned}
C &amp;= S e^{-qT} N(d_1) - K e^{-rT} N(d_2),\\[4pt]
P &amp;= K e^{-rT} N(-d_2) - S e^{-qT} N(-d_1),
\end{aligned}
$$</span> where<br />
<span class="math display">$$
d_{1,2} = \frac{\ln(S/K) + (r-q \pm
\tfrac12\sigma^2)T}{\sigma\sqrt{T}},\qquad
N(\cdot)=\text{standard normal CDF}.
$$</span> and <span class="math display">$$
N'(x)=\frac{1}{\sqrt{2\pi}}e^{-x^{2}/2}, \text{ is the standard normal
PDF}
$$</span> Let us plot the CDF and PDF for the normal distribution
different values of <span class="math inline"><em>Œº</em></span> and
<span class="math inline"><em>œÉ</em></span> below to gain some
intuition</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.standard_normal((<span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>, <span class="fl">0.01</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>plt.plot(x,norm.cdf(x), label<span class="op">=</span><span class="st">&#39;CDF&#39;</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span>) <span class="co"># CDF of standard normal distribution with mean=0 and std=1</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>plt.plot(x, norm.pdf(x), label<span class="op">=</span><span class="st">&#39;PDF&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>plt.plot(x,norm.cdf(x,<span class="dv">0</span>,<span class="fl">0.5</span>), label<span class="op">=</span><span class="st">&#39;PDF $\mu=0$, $\sigma=0.5$&#39;</span>,color<span class="op">=</span><span class="st">&#39;red&#39;</span>) <span class="co"># PDF of normal distribution with mean=0 and std=0.1</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>plt.plot(x,norm.pdf(x,<span class="dv">0</span>,<span class="fl">0.5</span>), label<span class="op">=</span><span class="st">&#39;CDF $\mu=0$, $\sigma=0.5$&#39;</span>,color<span class="op">=</span><span class="st">&#39;blue&#39;</span>) <span class="co"># CDF of normal distribution with mean=0 and std=0.1</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code></pre></div>
<div class="output execute_result" data-execution_count="296">
<pre><code>&lt;matplotlib.legend.Legend at 0x2904e62d308&gt;</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/7d8d716a0c7ae19e97f5385005d2bb7ee1a73911.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/f0113d414a6bd847272ec04c21591a609e7a7eae.png" /></p>
</div>
</div>
<div class="cell markdown">
<p><strong>Greeks: Formulas, Units, and Intuition</strong></p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 19%" />
<col style="width: 30%" />
<col style="width: 10%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th>Greek</th>
<th>Definition</th>
<th>Closed-form (call)</th>
<th>Units</th>
<th>Practical meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Delta</strong> <span class="math inline">$\displaystyle
\Delta = \frac{\partial V}{\partial S}$</span></td>
<td>Sensitivity to an <em>infinitesimal</em> change in spot price</td>
<td><span
class="math inline"><em>e</em><sup>‚àí<em>q</em><em>T</em></sup><em>N</em>(<em>d</em><sub>1</sub>)</span></td>
<td>dimensionless</td>
<td><strong>Hedge ratio</strong> ‚Äì hold <span
class="math inline"><em>Œî</em></span> shares per option to neutralise
first-order price moves.</td>
</tr>
<tr class="even">
<td><strong>Gamma</strong> <span class="math inline">$\displaystyle
\Gamma = \frac{\partial^{2} V}{\partial S^{2}}$</span></td>
<td>Curvature of price vs. spot</td>
<td><span class="math inline">$\displaystyle
\frac{e^{-qT}N'(d_1)}{S\sigma\sqrt{T}}$</span></td>
<td>1/price</td>
<td>Measures how <em>Delta</em> changes as <span
class="math inline"><em>S</em></span> moves; large near-ATM,
short-dated. Drives <em>convexity</em> benefits and risk of
delta-hedging error.</td>
</tr>
<tr class="odd">
<td><strong>Vega</strong> <span class="math inline">$\displaystyle \nu =
\frac{\partial V}{\partial \sigma}$</span></td>
<td>Volatility sensitivity</td>
<td><span class="math inline">$\displaystyle S e^{-qT}
N'(d_1)\sqrt{T}$</span></td>
<td>price per vol-point</td>
<td>How much the option‚Äôs value moves per 1 % absolute change in œÉ.
Central for volatility trading.</td>
</tr>
<tr class="even">
<td><strong>Theta</strong> <span class="math inline">$\displaystyle
\Theta = -\frac{\partial V}{\partial T}$</span></td>
<td>Time-decay (negative for long calls/puts)</td>
<td><span class="math inline">$\displaystyle -\frac{S e^{-qT}
N'(d_1)\sigma}{2\sqrt{T}} - r K e^{-rT} N(d_2) + q S e^{-qT}
N(d_1)$</span></td>
<td>price / year</td>
<td>P/L from <em>letting the clock tick</em>. Think of it as the ‚Äúrent
you pay‚Äù to be long optionality.</td>
</tr>
<tr class="odd">
<td><strong>Rho</strong> <span class="math inline">$\displaystyle \rho =
\frac{\partial V}{\partial r}$</span></td>
<td>Risk-free rate sensitivity</td>
<td><span
class="math inline"><em>K</em><em>T</em><em>e</em><sup>‚àí<em>r</em><em>T</em></sup><em>N</em>(<em>d</em><sub>2</sub>)</span></td>
<td>price / rate-pt</td>
<td>Gain/loss if the term structure shifts; opposite sign for puts.</td>
</tr>
<tr class="even">
<td><strong>Psi</strong> <span class="math inline">$\displaystyle \psi =
\frac{\partial V}{\partial q}$</span> (‚Äúdividend-rho‚Äù)</td>
<td>Dividend-yield sensitivity</td>
<td><span
class="math inline">‚ÄÖ‚àí‚ÄÖ<em>S</em><em>T</em><em>e</em><sup>‚àí<em>q</em><em>T</em></sup><em>N</em>(<em>d</em><sub>1</sub>)</span></td>
<td>price / yield-pt</td>
<td>Relevant for equity indexes with known dividend yield.</td>
</tr>
</tbody>
</table>
<hr />
<p><strong><em>Greeks in Risk Management &amp; Trading</em></strong></p>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 44%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="header">
<th>Greek</th>
<th>Typical hedging instrument</th>
<th>Why it matters day-to-day</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Delta</td>
<td>Underlying shares / futures</td>
<td>Neutralise directional exposure.</td>
</tr>
<tr class="even">
<td>Gamma</td>
<td>Additional options (usually shorter-dated)</td>
<td>Manage the <em>rate</em> at which delta changes; high gamma means
you must rebalance frequently.</td>
</tr>
<tr class="odd">
<td>Vega</td>
<td>Options at different strikes/expiries, variance swaps</td>
<td>Express pure volatility views (‚Äúvol trading‚Äù).</td>
</tr>
<tr class="even">
<td>Theta</td>
<td>Carry budget / financing</td>
<td>Determines expected daily bleed; options desks quote ‚Äútheta-dollars‚Äù
per night.</td>
</tr>
<tr class="odd">
<td>Rho</td>
<td>Bond futures / swaps</td>
<td>Small for equities but important in FX and rates options.</td>
</tr>
</tbody>
</table>
</div>
<div class="cell code" data-execution_count="410">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Second iteration of the code that used the &quot;sign&quot; for the option type (in the first iteration I had two different calculations for call and put options)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analytic_greek(S, K, T, sigma, r<span class="op">=</span><span class="fl">0.0</span>, q<span class="op">=</span><span class="fl">0.0</span>,  option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;call&quot;</span>):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> S<span class="op">*</span>np.exp(<span class="op">-</span>q <span class="op">*</span> T)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> K<span class="op">*</span>np.exp(<span class="op">-</span>r <span class="op">*</span> T)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    sqrtT  <span class="op">=</span> np.sqrt(T)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    d1 <span class="op">=</span> (np.log(S <span class="op">/</span> K) <span class="op">+</span> (r <span class="op">-</span> q <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> sigma <span class="op">**</span> <span class="dv">2</span>) <span class="op">*</span> T) <span class="op">/</span> (sigma <span class="op">*</span> np.sqrt(T))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    d2 <span class="op">=</span> (d1 <span class="op">-</span> sigma <span class="op">*</span> np.sqrt(T))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type <span class="op">==</span> <span class="st">&quot;call&quot;</span>:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        sign <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        sign <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    N1 <span class="op">=</span> norm.cdf(sign<span class="op">*</span>d1)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    N2 <span class="op">=</span> norm.cdf(sign<span class="op">*</span>d2)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    N1_prime <span class="op">=</span> norm.pdf(d1)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> sign<span class="op">*</span>(F<span class="op">*</span>N1 <span class="op">-</span> B<span class="op">*</span>N2)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> sign<span class="op">*</span>np.exp(<span class="op">-</span>q <span class="op">*</span> T) <span class="op">*</span> N1</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> np.exp(<span class="op">-</span>q <span class="op">*</span> T) <span class="op">*</span> N1_prime <span class="op">/</span> (S <span class="op">*</span> sigma <span class="op">*</span> sqrtT)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    vega  <span class="op">=</span> S <span class="op">*</span> np.exp(<span class="op">-</span>q <span class="op">*</span> T) <span class="op">*</span> N1_prime <span class="op">*</span> sqrtT</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> sign<span class="op">*</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> S <span class="op">*</span> np.exp(<span class="op">-</span>q <span class="op">*</span> T) <span class="op">*</span> N1_prime <span class="op">*</span> sigma <span class="op">/</span> sqrtT <span class="op">+</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span>q <span class="op">*</span> F <span class="op">*</span> N1 <span class="op">-</span> r <span class="op">*</span> B <span class="op">*</span> N2)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    rho   <span class="op">=</span> sign<span class="op">*</span>np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> K <span class="op">*</span> T <span class="op">*</span> N2</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price, d1, d2, delta, gamma, theta, vega, rho</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_analytic_greek():</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test the analytic_greek function for known case</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> analytic_greek(<span class="dv">100</span>, <span class="dv">95</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.isclose(X,[<span class="fl">11.534305993009554</span>, <span class="fl">0.4228768097884608</span>, <span class="fl">0.21503071288019557</span>, <span class="fl">0.6588474956611785</span>, <span class="fl">0.017421264426114427</span>, <span class="op">-</span><span class="fl">5.988989966253025</span>, <span class="fl">31.358275967005966</span>, <span class="fl">40.76283267983122</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>check_analytic_greek()</span></code></pre></div>
<div class="output execute_result" data-execution_count="6">
<pre><code>array([ True,  True,  True,  True,  True,  True,  True,  True])</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong><em>Intuition</em></strong></p>
<p>To gain a bit of intution for how the various parameters influence
the price of the options, we will plot them below and vary each of the
input parameters one by one</p>
</div>
<div class="cell code" data-execution_count="457">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>price1 <span class="op">=</span> []</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>price2 <span class="op">=</span> [] </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>price3 <span class="op">=</span> []</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>price4 <span class="op">=</span> []</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>price5 <span class="op">=</span> []</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>price6 <span class="op">=</span> []</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    price1.append(analytic_greek(<span class="dv">100</span><span class="op">+</span>i<span class="op">*</span><span class="dv">10</span>, <span class="dv">95</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    price2.append(analytic_greek(<span class="dv">100</span>, <span class="dv">95</span><span class="op">+</span>i<span class="op">*</span><span class="dv">10</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    price3.append(analytic_greek(<span class="dv">100</span>, <span class="dv">95</span>, <span class="fl">0.75</span><span class="op">+</span>i<span class="op">*</span><span class="fl">0.1</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    price4.append(analytic_greek(<span class="dv">100</span>, <span class="dv">95</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span><span class="op">+</span>i<span class="op">*</span><span class="fl">0.02</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    price5.append(analytic_greek(<span class="dv">100</span>, <span class="dv">95</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span><span class="op">+</span>i<span class="op">*</span><span class="fl">0.01</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    price6.append(analytic_greek(<span class="dv">100</span>, <span class="dv">95</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span><span class="op">+</span>i<span class="op">*</span><span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>)[<span class="dv">0</span>])</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>plot1 <span class="op">=</span> plt.figure()</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="dv">110</span>,<span class="dv">200</span>,<span class="dv">10</span>),price1, label<span class="op">=</span><span class="st">&#39;Option price vs stock price, with </span><span class="ch">\n</span><span class="st">$K = 95$, $T=0.75$, $\sigma=0.24$, $q=0.03$, $r=0.01$&#39;</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;S&#39;</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>plot2 <span class="op">=</span> plt.figure()</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="dv">105</span>,<span class="dv">105</span><span class="op">+</span><span class="dv">10</span><span class="op">*</span><span class="dv">9</span>,<span class="dv">10</span>),price2, label<span class="op">=</span><span class="st">&#39;Option price vs strike price, with </span><span class="ch">\n</span><span class="st">$S = 100$, $T=0.75$, $\sigma=0.24$, $q=0.03$, $r=0.01$&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;K&#39;</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>plot3 <span class="op">=</span> plt.figure()</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="fl">0.85</span>,<span class="fl">0.85</span><span class="op">+</span><span class="fl">0.1</span><span class="op">*</span><span class="dv">9</span>,<span class="fl">0.1</span>),price3, label<span class="op">=</span><span class="st">&#39;Option price vs time to maturity, with </span><span class="ch">\n</span><span class="st">$S = 100$, $K=95$, $\sigma=0.24$, $q=0.03$, $r=0.01$&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;T&#39;</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>plot4 <span class="op">=</span> plt.figure()</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="fl">0.24</span>,<span class="fl">0.24</span><span class="op">+</span><span class="fl">0.02</span><span class="op">*</span><span class="dv">9</span>,<span class="fl">0.02</span>),price4, label<span class="op">=</span><span class="st">&#39;Option price vs volatility $\sigma$, with </span><span class="ch">\n</span><span class="st"> $S = 100$, $K=95$, $T=0.75$, $q=0.03$, $r=0.01$&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;$\sigma$&#39;</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>plot5 <span class="op">=</span> plt.figure()</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="fl">0.03</span>,<span class="fl">0.03</span><span class="op">+</span><span class="fl">0.01</span><span class="op">*</span><span class="dv">9</span>,<span class="fl">0.01</span>),price5, label<span class="op">=</span><span class="st">&#39;Option price vs $q$, with </span><span class="ch">\n</span><span class="st"> $S = 100$, $K=95$, $T=0.75$, $\sigma=0.24$, $r=0.01$&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;r&#39;</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>plot6 <span class="op">=</span> plt.figure()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>plt.plot(np.arange(<span class="fl">0.01</span>,<span class="fl">0.01</span><span class="op">+</span><span class="fl">0.01</span><span class="op">*</span><span class="dv">9</span>,<span class="fl">0.01</span>),price6, label<span class="op">=</span><span class="st">&#39;Option price vs $r$, with </span><span class="ch">\n</span><span class="st"> $S = 100$, $K=95$, $T=0.75$, $\sigma=0.24$, $q=0.03$&#39;</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;q&#39;</span>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Price&#39;</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code></pre></div>
<div class="output execute_result" data-execution_count="457">
<pre><code>&lt;matplotlib.legend.Legend at 0x205823d3048&gt;</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/1a5dc8fee27184ddee4d8ca15c0d91d99ca88942.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/0902ec8a26dcde63c1d2b2f6cb53c5a969454b7b.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/2fc3a4a3196e201debd2fa5188cc582fce6293de.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/adaf9879f21e1570cf479edacff1e50877496875.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/f121c67548e53fc3332682313f298ac3d2a42901.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/0ec8da81d7958f0607d19ad7d9fb327a04aba45a.png" /></p>
</div>
</div>
<section id="monte-carlo-of-european-and-asian-options"
class="cell markdown">
<h2>Monte carlo of European and Asian options</h2>
</section>
<div class="cell markdown">
<p><strong>European options</strong> can be exercised on their
experiation date. We simulate the pricepath by iteratively updating the
price by <span
class="math inline">$S_{i}=S_{i-1}e^{(r-q-\frac{1}{2}\sigma^2)\text{d}t+\sigma
\sqrt{\text{d}t}Z_i}$</span>, with Z being Monte Carlo generated
numbers.</p>
<p>For Asian (european) options the final price is given as an average
over some pre-disclosed time interval. If there is only one timestep,
this will be equal to the European option.</p>
<p>American options can be exercised at any point. For the american
option there is no closed form solution</p>
</div>
<div class="cell code" data-execution_count="367">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mc_euro(S0, K, T, sigma, r<span class="op">=</span><span class="fl">0.0</span>, q<span class="op">=</span><span class="fl">0.0</span>, option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> T <span class="op">/</span> nsteps</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.zeros((npaths, nsteps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    S[:, <span class="dv">0</span>] <span class="op">=</span> S0</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nsteps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> np.random.standard_normal(npaths)  <span class="co"># standard normal random variables</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        S[:,i] <span class="op">=</span> S[:, i <span class="op">-</span> <span class="dv">1</span>]<span class="op">*</span>np.exp((r <span class="op">-</span> q <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma <span class="op">**</span> <span class="dv">2</span>) <span class="op">*</span> dt <span class="op">+</span> sigma <span class="op">*</span> np.sqrt(dt) <span class="op">*</span> Z)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type <span class="op">==</span> <span class="st">&quot;call&quot;</span>:</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.mean(np.maximum(S[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> K, <span class="dv">0</span>))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        err <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.std(np.maximum(S[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> K, <span class="dv">0</span>)) <span class="op">/</span> np.sqrt(npaths)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> option_type <span class="op">==</span> <span class="st">&quot;put&quot;</span>:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.mean(np.maximum(K <span class="op">-</span> S[:, <span class="op">-</span><span class="dv">1</span>], <span class="dv">0</span>))</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        err <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.std(np.maximum(K <span class="op">-</span> S[:, <span class="op">-</span><span class="dv">1</span>], <span class="dv">0</span>)) <span class="op">/</span> np.sqrt(npaths)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price, err</span></code></pre></div>
</div>
<div class="cell markdown">
<p><strong><em>Checks</em></strong></p>
<p>Let us check the accuracy compared to the analytic solution and how
it changes as N changes:</p>
</div>
<div class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_mc(S,K,T,sigma,r,q):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> analytic_greek(S,K,T,sigma,r,q,<span class="st">&quot;call&quot;</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    dif <span class="op">=</span> [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">6</span>):</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> mc_euro(S,K,T,sigma,r,q, <span class="st">&quot;call&quot;</span> , <span class="dv">10</span><span class="op">**</span>(i), <span class="dv">1000</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        dif[i<span class="op">-</span><span class="dv">2</span>] <span class="op">=</span> np.<span class="bu">abs</span>(X[<span class="dv">0</span>] <span class="op">-</span> Y[<span class="dv">0</span>])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> plt.plot([<span class="st">&#39;$10^2$&#39;</span>,<span class="st">&#39;$10^3$&#39;</span>,<span class="st">&#39;$10^4$&#39;</span>,<span class="st">&#39;$10^5$&#39;</span>,<span class="st">&#39;$10^6$&#39;</span>], dif)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;|Analytic-Monte-carlo|&#39;</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out, dif</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>check_mc(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="17">
<pre><code>([&lt;matplotlib.lines.Line2D at 0x26c02631d08&gt;],
 [1.8632217301042777,
  0.43289368845146203,
  0.17649723536118866,
  0.09586271621154818,
  0])</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/c4ab239544b428fe6af2d9b539e11ac4886899c9.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>The plot above should go to 0 as <span
class="math inline"><em>N</em>‚ÄÑ‚Üí‚ÄÑ‚àû</span></p>
</div>
<div class="cell markdown">
<p><strong><em>Asian options</em></strong></p>
<p>Lets now do a MC of asian options. This is similar to the European
option, but in the end we take the mean over the values of S during the
path, to set the price</p>
</div>
<div class="cell code" data-execution_count="358">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mc_asian(S0,K,T,sigma,r,q,option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> T<span class="op">/</span>nsteps</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.zeros((npaths, nsteps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    S[:, <span class="dv">0</span>] <span class="op">=</span> S0</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nsteps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> np.random.standard_normal(npaths)  <span class="co"># standard normal random variables</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        S[:,i] <span class="op">=</span> S[:, i <span class="op">-</span> <span class="dv">1</span>]<span class="op">*</span>np.exp((r <span class="op">-</span> q <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma <span class="op">**</span> <span class="dv">2</span>) <span class="op">*</span> dt <span class="op">+</span> sigma <span class="op">*</span> np.sqrt(dt) <span class="op">*</span> Z)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    S_mean <span class="op">=</span> np.mean(S[:, <span class="dv">1</span>:], axis<span class="op">=</span><span class="dv">1</span>)  <span class="co"># mean of the paths</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type <span class="op">==</span> <span class="st">&quot;call&quot;</span>:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.mean(np.maximum(S_mean <span class="op">-</span> K, <span class="dv">0</span>))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        err <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.std(np.maximum(S_mean <span class="op">-</span> K, <span class="dv">0</span>)) <span class="op">/</span> np.sqrt(npaths)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> option_type <span class="op">==</span> <span class="st">&quot;put&quot;</span>:</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.mean(np.maximum(K <span class="op">-</span> S_mean, <span class="dv">0</span>))</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        err <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> T) <span class="op">*</span> np.std(np.maximum(K <span class="op">-</span> S_mean, <span class="dv">0</span>)) <span class="op">/</span> np.sqrt(npaths)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="364">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mc_asian(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">1000</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="364">
<pre><code>3.0744791001245564</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Let us test that this is equal to the European options when taking
nsteps = 1 (i.e. ending the Monte Carlo paths immediatly, so the average
is the same as the final value)</p>
</div>
<div class="cell code" data-execution_count="374">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_regression_to_euro(S,K,T,sigma,r,q,option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    nsteps<span class="op">=</span><span class="dv">1</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> mc_asian(S, K, T, sigma, r ,q ,<span class="st">&quot;call&quot;</span>, npaths, nsteps)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> mc_euro(S, K, T, sigma, r, q, <span class="st">&quot;call&quot;</span>, npaths, nsteps)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> analytic_greek(S, K, T, sigma, r, q, <span class="st">&quot;call&quot;</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.isclose(X,Y[<span class="dv">0</span>],<span class="dv">10</span><span class="op">**</span>(<span class="op">-</span><span class="dv">2</span>)),np.isclose(X,Z[<span class="dv">0</span>],<span class="dv">10</span><span class="op">**</span>(<span class="op">-</span><span class="dv">2</span>)), X, Y[<span class="dv">0</span>], Z[<span class="dv">0</span>]</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> test_regression_to_euro(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">1000000</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Test if Asian mc is close to Euro mc: &quot;</span>, out[<span class="dv">0</span>])</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Test if Asian mc is close to Euro analytic: &quot;</span>, out[<span class="dv">1</span>])</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Asian mc price: &quot;</span>, out[<span class="dv">2</span>])</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Euro mc price: &quot;</span>, out[<span class="dv">3</span>])</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Euro analytic price: &quot;</span>, out[<span class="dv">4</span>])</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Test if Asian mc is close to Euro mc:  True
Test if Asian mc is close to Euro analytic:  True
Asian mc price:  6.747275842146164
Euro mc price:  6.767607887475131
Euro analytic price:  6.760519238235446
</code></pre>
</div>
</div>
<section id="american-options" class="cell markdown">
<h2>American options</h2>
</section>
<div class="cell markdown">
<p>For the american options things get more complicated since we can
exercise early. First let us do the "simplest" thing and just do Monte
Carlo and just simulate the paths and find the average price that givs
the highest pay-off. This will give an "upper bound" on the price.</p>
</div>
<div class="cell code" data-execution_count="458">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mc_american_simple(S0, K, T, sigma, r<span class="op">=</span><span class="fl">0.0</span>, q<span class="op">=</span><span class="fl">0.0</span>, option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;put&quot;</span>, npaths <span class="op">=</span> <span class="dv">10000</span>, nsteps <span class="op">=</span> <span class="dv">100</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First we simulate the paths, using the same method as in mc_euro.</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    dt    <span class="op">=</span> T <span class="op">/</span> nsteps</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    drift <span class="op">=</span> (r <span class="op">-</span> q <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> dt</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    diff  <span class="op">=</span> sigma <span class="op">*</span> np.sqrt(dt)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.empty((npaths, nsteps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    S[:, <span class="dv">0</span>] <span class="op">=</span> S0</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nsteps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> np.random.standard_normal(npaths)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        S[:, t] <span class="op">=</span> S[:, t<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> np.exp(drift <span class="op">+</span> diff <span class="op">*</span> Z)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type <span class="op">==</span> <span class="st">&quot;call&quot;</span>:</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.maximum(S <span class="op">-</span> K, <span class="fl">0.0</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> option_type <span class="op">==</span> <span class="st">&quot;put&quot;</span>:</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.maximum(K <span class="op">-</span> S, <span class="fl">0.0</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    disc_vec <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> dt <span class="op">*</span> np.arange(nsteps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    discounted <span class="op">=</span> price <span class="op">*</span> disc_vec </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    payoff_path <span class="op">=</span> discounted.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>) </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    price  <span class="op">=</span> payoff_path.mean()</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    stderr <span class="op">=</span> payoff_path.std(ddof<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> np.sqrt(npaths)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price, stderr, </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>mc_american_simple(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">100</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="458">
<pre><code>(12.90106253980661, 0.14691889059074761)</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong>LS monte carlo for american options</strong></p>
<p>Let us now consider two different algorithms for pricing options. The
first one is the Schwartz-Longstaff algorithm (<a
href="https://people.math.ethz.ch/%7Ehjfurrer/teaching/LongstaffSchwartzAmericanOptionsLeastSquareMonteCarlo.pdf"
class="uri">https://people.math.ethz.ch/%7Ehjfurrer/teaching/LongstaffSchwartzAmericanOptionsLeastSquareMonteCarlo.pdf</a>)</p>
<p>Here we do the normal monte carlo path, but we determine a stopping
condition from a linear regression that we propagate backwards at each
step in the path</p>
</div>
<div class="cell code" data-execution_count="587">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mc_american(S0, K, T, sigma, r<span class="op">=</span><span class="fl">0.0</span>, q<span class="op">=</span><span class="fl">0.0</span>, option_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;call&quot;</span>, npaths <span class="op">=</span> <span class="dv">10000</span>, nsteps <span class="op">=</span> <span class="dv">100</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    dt    <span class="op">=</span> T <span class="op">/</span> nsteps</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    drift <span class="op">=</span> (r <span class="op">-</span> q <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> dt</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    diff  <span class="op">=</span> sigma <span class="op">*</span> np.sqrt(dt)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> np.empty((npaths, nsteps <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    S[:, <span class="dv">0</span>] <span class="op">=</span> S0</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nsteps <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        Z <span class="op">=</span> np.random.standard_normal(npaths)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        S[:, t] <span class="op">=</span> S[:, t<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> np.exp(drift <span class="op">+</span> diff <span class="op">*</span> Z)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type.lower() <span class="op">==</span> <span class="st">&quot;call&quot;</span>:</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> h(s):</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.maximum(s <span class="op">-</span> K, <span class="fl">0.0</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> option_type.lower() <span class="op">==</span> <span class="st">&quot;put&quot;</span>:</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> h(s):</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.maximum(K <span class="op">-</span> s, <span class="fl">0.0</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Longstaff‚ÄìSchwartz backward loop</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> np.exp(<span class="op">-</span>r <span class="op">*</span> dt)            </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> h(S[:, <span class="op">-</span><span class="dv">1</span>])    </span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(nsteps <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">*=</span> disc                     </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        itm <span class="op">=</span> h(S[:, t]) <span class="op">&gt;</span> <span class="dv">0</span>    </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> itm.<span class="bu">any</span>():</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> S[itm, t]         </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> cash[itm]                     </span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Perform regression using least squared fit on X and Y with basis 1, S, S¬≤</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        A <span class="op">=</span> np.column_stack((np.ones_like(X),  X, X<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        beta, <span class="op">*</span>_ <span class="op">=</span> np.linalg.lstsq(A, Y)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># continuation value by evaluating on the regression coefficients</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        continuation <span class="op">=</span> A <span class="op">@</span> beta </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        exercise <span class="op">=</span> h(X) <span class="op">&gt;</span> continuation</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        idx      <span class="op">=</span> np.where(itm)[<span class="dv">0</span>]</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        cash[idx[exercise]] <span class="op">=</span> h(X[exercise])</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    price  <span class="op">=</span> disc <span class="op">*</span> cash.mean()</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price</span></code></pre></div>
</div>
<div class="cell markdown">
<p><strong>Check</strong></p>
<p>Let us check that the new mc alogrithm is less than the previous one
(the simple algorithm we wrote is an "upper bound")</p>
</div>
<div class="cell code" data-execution_count="583">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>A1 <span class="op">=</span> mc_american_simple(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>A2 <span class="op">=</span> mc_american(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>,<span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="dv">10000</span>, nsteps<span class="op">=</span><span class="dv">100</span>)[<span class="dv">0</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;American mc price: &quot;</span>, A2, <span class="st">&quot;is less than the upper bound&quot;</span>, A1[<span class="dv">0</span>])</span></code></pre></div>
<div class="output stream stdout">
<pre><code>American mc price:  6.8402841287091745 is less than the upper bound 13.055980940861925
</code></pre>
</div>
</div>
<div class="cell markdown">
<p><strong><em>Binomial tree</em></strong></p>
<p>Now let's do this using a binomial tree. This is a technique used to
value options by simulating possible paths the underlying asset's price
could take over the option's life. Here we assume the price of the
underlying asset can only move up or down by a certain amount in each
time, creating a binomial tree of possible price movements.</p>
<p>Before we code it up, let us look at a simple 2 timestep example for
an american put. We take the following input values:</p>
<table>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Spot <span class="math inline"><em>S</em><sub>0</sub></span></td>
<td><strong>$100</strong></td>
</tr>
<tr class="even">
<td>Strike <span class="math inline"><em>K</em></span></td>
<td><strong>$105</strong></td>
</tr>
<tr class="odd">
<td>Maturity <span class="math inline"><em>T</em></span></td>
<td><strong>0.25 yr</strong> (= 3 months)</td>
</tr>
<tr class="even">
<td>Volatility <span class="math inline"><em>œÉ</em></span></td>
<td><strong>30 %</strong> p.a.</td>
</tr>
<tr class="odd">
<td>Risk-free rate <span class="math inline"><em>r</em></span></td>
<td><strong>5 %</strong> p.a.</td>
</tr>
<tr class="even">
<td>Dividend yield <span class="math inline"><em>q</em></span></td>
<td>0</td>
</tr>
<tr class="odd">
<td>Steps <span class="math inline"><em>N</em></span></td>
<td><strong>2</strong> (so only three layers: 0, 1, 2)</td>
</tr>
</tbody>
</table>
<p>The binomial tree then has the following parameters, taken from
"Option pricing: A simplified approach" by John C. Cox, Stephen A. Ross,
and Mark Rubinstein: <a
href="https://www.sciencedirect.com/science/article/pii/0304405X79900151"
class="uri">https://www.sciencedirect.com/science/article/pii/0304405X79900151</a></p>
<p><span class="math display">$$
\begin{aligned}
\Delta t &amp;= T/N = 0.25/2 = 0.125,\\[2pt]
u &amp;= e^{\sigma\sqrt{\Delta t}}
   = e^{0.30\sqrt{0.125}}\approx 1.1118,\\
d &amp;= 1/u \approx 0.8993,\\
p &amp;= \frac{e^{(r-q)\Delta t}-d}{u-d}
   =\frac{e^{0.05\cdot0.125}-0.8993}{1.1118-0.8993}
   \approx 0.503,\\
\text{disc} &amp;= e^{-r\Delta t}=e^{-0.05\cdot0.125}=0.99377 .
\end{aligned}
$$</span></p>
<p>Then at each step we calculate all the possible up and down values
according to <span
class="math inline"><em>S</em><sub><em>i</em>,‚ÄÜ<em>j</em></sub>‚ÄÑ=‚ÄÑ<em>S</em><sub>0</sub><em>u</em><sup>‚ÄÜ<em>i</em>‚ÄÖ‚àí‚ÄÖ<em>j</em></sup><em>d</em><sup>‚ÄÜ<em>j</em></sup></span></p>
<table>
<thead>
<tr class="header">
<th>Time</th>
<th>Node</th>
<th>Stock price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline"><em>t</em><sub>0</sub></span></td>
<td>(0,0)</td>
<td><strong>100.00</strong></td>
</tr>
<tr class="even">
<td><span class="math inline"><em>t</em><sub>1</sub></span></td>
<td>up (1,0)</td>
<td>111.18<br>(<span class="math inline">100<em>u</em></span>)</td>
</tr>
<tr class="odd">
<td></td>
<td>down (1,1)</td>
<td>89.93<br>(<span class="math inline">100<em>d</em></span>)</td>
</tr>
<tr class="even">
<td><span class="math inline"><em>t</em><sub>2</sub></span></td>
<td>uu (2,0)</td>
<td>123.97</td>
</tr>
<tr class="odd">
<td></td>
<td>ud / du (2,1)</td>
<td>100.00</td>
</tr>
<tr class="even">
<td></td>
<td>dd (2,2)</td>
<td>80.94</td>
</tr>
</tbody>
</table>
<p>We then take the terminal intrinsic pay-offs for a put <span
class="math inline"><em>h</em>(<em>S</em>)‚ÄÑ=‚ÄÑmax‚ÄÜ(<em>K</em>‚àí<em>S</em>,0)</span>
and calculate it at the final step:</p>
<table>
<thead>
<tr class="header">
<th>Node</th>
<th><span class="math inline"><em>S</em></span></th>
<th><span class="math inline"><em>h</em>(<em>S</em>)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>uu</td>
<td>123.97</td>
<td>0</td>
</tr>
<tr class="even">
<td>ud/du</td>
<td>100.00</td>
<td><strong>5.00</strong></td>
</tr>
<tr class="odd">
<td>dd</td>
<td>80.94</td>
<td><strong>24.06</strong></td>
</tr>
</tbody>
</table>
<p>we then do the same for the previous step</p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 54%" />
<col style="width: 10%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th>Node</th>
<th><span class="math inline"><em>S</em></span></th>
<th>Continuation <span
class="math inline"><em>C</em>=‚ÄÜdisc‚ÄÜ[<em>p</em><em>V</em><sub>up</sub>+(1‚àí<em>p</em>)<em>V</em><sub>down</sub>]</span></th>
<th>Intrinsic <span class="math inline"><em>h</em></span></th>
<th><span
class="math inline"><em>V</em><sub>1,‚ÄÜ<em>a</em><em>l</em><em>l</em></sub></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>up</strong></td>
<td>111.18</td>
<td><span
class="math inline">0.99377‚ÄÜ(0.503‚ãÖ0+0.497‚ãÖ5)‚ÄÑ=‚ÄÑ2.47</span></td>
<td>0</td>
<td><strong>2.47</strong></td>
</tr>
<tr class="even">
<td><strong>down</strong></td>
<td>89.93</td>
<td><span
class="math inline">0.99377‚ÄÜ(0.503‚ãÖ5+0.497‚ãÖ24.06)‚ÄÑ=‚ÄÑ14.37</span></td>
<td>15.07</td>
<td><strong>15.07</strong> <em>(early exercise)</em></td>
</tr>
</tbody>
</table>
<p>and finally for the initial step</p>
<p><span class="math display">$$
\begin{aligned}
C_0 &amp;= 0.99377\bigl(0.503\cdot2.47 + 0.497\cdot15.07\bigr)=8.68,\\
h_0 &amp;= 105-100 = 5.00,\\
V_0 &amp;= \max(5.00,\;8.68)=8.68.
\end{aligned}
$$</span></p>
<p>So the two-step American put price is $8.68.</p>
<p>Let us implement this now below</p>
</div>
<div class="cell code" data-execution_count="584">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> binomial_american(S0,K,T,sigma,r<span class="op">=</span><span class="dv">0</span>,q<span class="op">=</span><span class="dv">0</span>,option_type<span class="op">=</span><span class="st">&quot;put&quot;</span>,N<span class="op">=</span><span class="dv">400</span>):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    dt   <span class="op">=</span> T<span class="op">/</span>N</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    u    <span class="op">=</span> np.exp(sigma<span class="op">*</span>np.sqrt(dt))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    d    <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>u</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    p    <span class="op">=</span> (np.exp((r<span class="op">-</span>q)<span class="op">*</span>dt) <span class="op">-</span> d) <span class="op">/</span> (u <span class="op">-</span> d)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    disc <span class="op">=</span> np.exp(<span class="op">-</span>r<span class="op">*</span>dt)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># terminal prices &amp; pay-offs</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    j <span class="op">=</span> np.arange(N<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> S0 <span class="op">*</span> u<span class="op">**</span>(N<span class="op">-</span>j) <span class="op">*</span> d<span class="op">**</span>j</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> option_type<span class="op">==</span><span class="st">&quot;call&quot;</span>:</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> np.maximum(S<span class="op">-</span>K,<span class="dv">0</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> np.maximum(K<span class="op">-</span>S,<span class="dv">0</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># backward induction</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        S <span class="op">=</span> S0 <span class="op">*</span> u<span class="op">**</span>(i<span class="op">-</span>j[:i<span class="op">+</span><span class="dv">1</span>]) <span class="op">*</span> d<span class="op">**</span>j[:i<span class="op">+</span><span class="dv">1</span>]   <span class="co"># prices at layer i</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> disc<span class="op">*</span>(p<span class="op">*</span>V[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> (<span class="dv">1</span><span class="op">-</span>p)<span class="op">*</span>V[<span class="dv">1</span>:])      <span class="co"># continuation</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> np.maximum(V,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>                       np.maximum(S<span class="op">-</span>K,<span class="dv">0</span>) <span class="cf">if</span> option_type<span class="op">==</span><span class="st">&quot;call&quot;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">else</span> np.maximum(K<span class="op">-</span>S,<span class="dv">0</span>))</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> V[<span class="dv">0</span>]</span></code></pre></div>
</div>
<div class="cell markdown">
<p><strong><em>Checks</em></strong></p>
<p>To check this we first compare it to the monte carlo solution and see
how they should approach each other as the number of steps for MC goes
to <span class="math inline">‚àû</span></p>
</div>
<div class="cell code" data-execution_count="585">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>A2 <span class="op">=</span> binomial_american(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="st">&quot;call&quot;</span>, N<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> []</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>er <span class="op">=</span> []</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>Nend <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2</span>, Nend)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, Nend):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    A1 <span class="op">=</span> mc_american(<span class="dv">100</span>, <span class="dv">105</span>, <span class="fl">0.75</span>, <span class="fl">0.24</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="st">&quot;call&quot;</span>, npaths<span class="op">=</span><span class="bu">int</span>(<span class="dv">10</span><span class="op">**</span>(<span class="fl">0.5</span><span class="op">*</span>i)), nsteps<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    Y.append(np.<span class="bu">abs</span>(A1[<span class="dv">0</span>]<span class="op">-</span>A2))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>plt.plot(X,Y)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Number of paths&#39;</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;MC - Binomial&#39;</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Convergence of MC to Binomial&#39;</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="585">
<pre><code>Text(0.5, 1.0, &#39;Convergence of MC to Binomial&#39;)</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3231f969767b414fb6d892fd56ffb462/72a4fb73c6840daa98c5324fdc786ab663b3ffb8.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Another check is that for <span
class="math inline"><em>q</em>‚ÄÑ=‚ÄÑ0</span> the call option prices of
european and american options should be the same, so let us check that
they match</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>am_call <span class="op">=</span> binomial_american(<span class="dv">100</span>, <span class="dv">100</span>, <span class="fl">1.0</span>, <span class="fl">0.2</span>, <span class="fl">0.05</span>, <span class="fl">0.0</span>,<span class="st">&quot;call&quot;</span>, N)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>eu_call <span class="op">=</span> analytic_greek(<span class="dv">100</span>, <span class="dv">100</span>, <span class="fl">1.0</span>, <span class="fl">0.2</span>, <span class="fl">0.05</span>, <span class="fl">0.0</span>)[<span class="dv">0</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>diff_call <span class="op">=</span> <span class="bu">abs</span>(am_call <span class="op">-</span> eu_call)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>errpass <span class="op">=</span> <span class="dv">2</span><span class="op">/</span>N</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;European call (analytic) : </span><span class="sc">{</span>eu_call<span class="sc">:.6f}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;American  call (tree)   : </span><span class="sc">{</span>am_call<span class="sc">:.6f}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Abs diff                : </span><span class="sc">{</span>diff_call<span class="sc">:.6e}</span><span class="ss">&quot;</span>) </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Threshold               : </span><span class="sc">{</span>errpass<span class="sc">:.6e}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> diff_call <span class="op">&lt;</span> errpass:</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;PASS  (call prices match within&quot;</span>, errpass)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;FAIL  (call prices not within&quot;</span>, errpass)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>European call (analytic) : 10.450584
American  call (tree)   : 10.450384
Abs diff                : 1.999693e-04
Threshold               : 2.000000e-04
PASS  (call prices match within 0.0002
</code></pre>
</div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
</body>
</html>
